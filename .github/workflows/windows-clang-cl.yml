name: Build (clang-cl on Windows)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install LLVM (clang/clang-cl) via Chocolatey
        shell: cmd
        run: choco install -y llvm || choco install -y llvm --no-progress

      - name: Download and extract LLVM release (GitHub)
        shell: bash
        run: |
          set -euo pipefail
          url="https://github.com/llvm/llvm-project/releases/download/llvmorg-21.1.7/clang+llvm-21.1.7-x86_64-pc-windows-msvc.tar.xz"
          dest=clang.tar.xz
          echo "Downloading $url to $dest"
          curl -L -o "$dest" "$url"

          echo "Extracting $dest"

          # Prefer tar if it supports xz; fallback to 7z extraction and handle variable tar names
          if command -v tar >/dev/null 2>&1 && tar --version 2>&1 | grep -qi xz; then
            echo "Using tar -xJf to extract"
            tar -xJf "$dest"
            # get the top-level directory extracted (first member path)
            topdir=$(tar -tf "$dest" | head -n1 | cut -f1 -d"/")
            clangBin="$(pwd)/$topdir/bin"

          else
            echo "tar with xz support not available; using 7z fallback"
            7z x "$dest" -y
            # locate the .tar that was produced (if any)
            tarfile=$(ls *.tar 2>/dev/null | head -n1 || true)
            if [ -n "$tarfile" ]; then
              echo "Found tarfile: $tarfile - extracting"
              7z x "$tarfile" -y -oclang
              # find the extracted clang+llvm directory under ./clang
              topdir=$(ls -d clang/clang+llvm-* 2>/dev/null | head -n1 | sed -e 's#clang/##')
              clangBin="$(pwd)/clang/$topdir/bin"
            else
              # maybe 7z already extracted directory directly
              topdir=$(ls -d clang+llvm-* 2>/dev/null | head -n1 || true)
              if [ -n "$topdir" ]; then
                clangBin="$(pwd)/$topdir/bin"
              else
                echo "ERROR: could not locate extracted files"
                ls -la || true
                exit 2
              fi
            fi
          fi

          echo "LLVM bin path: $clangBin"
          echo "Adding $clangBin to PATH for this job"
          echo "PATH=$clangBin:$PATH" >> $GITHUB_ENV

      - name: Show clang-cl version
        shell: bash
        run: |
          command -v clang-cl || true
          clang-cl --version || true

      - name: Configure with CMake (Visual Studio generator + ClangCL toolset)
        shell: bash
        run: |
          # Use the Visual Studio generator and request the ClangCL toolset.
          # Adjust generator name/architecture if you target another VS version or architecture.
          cmake -S . -B build -G "Visual Studio 17 2022" -A x64 -T ClangCL -DCMAKE_BUILD_TYPE=Release

      - name: Build
        shell: bash
        run: |
          cmake --build build --config Release -- /m

      - name: Run executable (Release)
        shell: bash
        run: |
          ./build/Release/sample.exe