name: Build (clang-cl on Windows)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install LLVM (clang/clang-cl) via Chocolatey
        shell: cmd
        run: choco install -y llvm || choco install -y llvm --no-progress

      - name: Download and extract LLVM release (GitHub)
        shell: bash
        run: |
          url="https://github.com/llvm/llvm-project/releases/download/llvmorg-21.1.7/clang+llvm-21.1.7-x86_64-pc-windows-msvc.tar.xz"
          dest=clang.tar.xz
          echo "Downloading $url to $dest"
          curl -L -o "$dest" "$url"

          echo "Extracting $dest (requires 7z present on runner)"
          # 7z will first extract the .tar from the .tar.xz, then extract the tar contents.
          7z x "$dest" -y
          tarfile="clang+llvm-21.1.7-x86_64-pc-windows-msvc.tar"
          7z x "$tarfile" -y -oclang

          echo "LLVM extracted to: $(pwd)/clang"
          clangBin="$(pwd)/clang/clang+llvm-21.1.7-x86_64-pc-windows-msvc/bin"
          echo "Adding $clangBin to PATH for this step and subsequent steps"
          export PATH="$clangBin:$PATH"
          # Persist to subsequent steps
          echo "PATH=$clangBin:$PATH" >> $GITHUB_ENV

      - name: Show clang-cl version
        shell: bash
        run: |
          command -v clang-cl || true
          clang-cl --version || true

      - name: Configure with CMake (Visual Studio generator + ClangCL toolset)
        shell: bash
        run: |
          # Use the Visual Studio generator and request the ClangCL toolset.
          # Adjust generator name/architecture if you target another VS version or architecture.
          cmake -S . -B build -G "Visual Studio 17 2022" -A x64 -T ClangCL -DCMAKE_BUILD_TYPE=Release

      - name: Build
        shell: bash
        run: |
          cmake --build build --config Release -- /m

      - name: Run executable (Release)
        shell: bash
        run: |
          ./build/Release/sample.exe