name: Build (clang-cl on Windows)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: actions-setup-cmake
        uses: jwlawson/actions-setup-cmake@v2.0.2

      - name: Setup Visual Studio Developer Prompt
        if: ${{ runner.os == 'Windows' }}
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: amd64

      - name: Download LLVM
        shell: bash
        run: |
          echo "Downloading LLVM..."
          curl -LO https://github.com/llvm/llvm-project/releases/download/llvmorg-21.1.8/clang+llvm-21.1.8-x86_64-pc-windows-msvc.tar.xz

      - name: Extract LLVM
        shell: bash
        run: |
          echo "Extracting LLVM..."
          tar -xf clang+llvm-21.1.8-x86_64-pc-windows-msvc.tar.xz
          
          mv clang+llvm-21.1.8-x86_64-pc-windows-msvc llvm

      - name: Configure with CMake
        shell: bash
        run: |
          root=$PWD
          mkdir build
          cd build
          cmake -G "Ninja" -DCMAKE_BUILD_TYPE=Release -S .. -DCMAKE_INSTALL_PREFIX:PATH=../install -DCMAKE_C_COMPILER="$root/llvm/bin/clang.exe" -DCMAKE_CXX_COMPILER="$root/llvm/bin/clang++.exe" -DCMAKE_CXX_SCAN_FOR_MODULES=1

      - name: Build
        shell: bash
        run: |
          cmake --build .

      - name: Run executable (Release)
        shell: bash
        run: |
          ./build/Release/sample.exe
